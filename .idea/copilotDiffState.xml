<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/panicbuttonrtdb/prensentation/components/ToggleSwitch.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/panicbuttonrtdb/prensentation/components/ToggleSwitch.kt" />
              <option name="originalContent" value="package com.example.panicbuttonrtdb.prensentation.components&#10;&#10;import android.content.Context&#10;import android.os.VibrationEffect&#10;import android.os.Vibrator&#10;import android.util.Log&#10;import android.widget.Toast&#10;import androidx.compose.foundation.layout.Arrangement&#10;import androidx.compose.foundation.layout.Column&#10;import androidx.compose.foundation.layout.Row&#10;import androidx.compose.foundation.layout.Spacer&#10;import androidx.compose.foundation.layout.fillMaxWidth&#10;import androidx.compose.foundation.layout.height&#10;import androidx.compose.foundation.layout.padding&#10;import androidx.compose.foundation.layout.size&#10;import androidx.compose.foundation.layout.width&#10;import androidx.compose.material3.AlertDialog&#10;import androidx.compose.material3.Button&#10;import androidx.compose.material3.ButtonDefaults&#10;import androidx.compose.material3.ExperimentalMaterial3Api&#10;import androidx.compose.material3.Icon&#10;import androidx.compose.material3.MaterialTheme&#10;import androidx.compose.material3.OutlinedTextField&#10;import androidx.compose.material3.Switch&#10;import androidx.compose.material3.SwitchDefaults&#10;import androidx.compose.material3.Text&#10;import androidx.compose.material3.TextFieldDefaults&#10;import androidx.compose.runtime.Composable&#10;import androidx.compose.runtime.LaunchedEffect&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.livedata.observeAsState&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.remember&#10;import androidx.compose.runtime.setValue&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.scale&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.res.colorResource&#10;import androidx.compose.ui.res.painterResource&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.unit.sp&#10;import com.example.panicbuttonrtdb.R&#10;import com.example.panicbuttonrtdb.notification.sendNotification&#10;import com.example.panicbuttonrtdb.viewmodel.ViewModel&#10;import kotlinx.coroutines.delay&#10;import androidx.compose.foundation.layout.PaddingValues&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.foundation.layout.ExperimentalLayoutApi // &lt;-- IMPORT BARU&#10;import androidx.compose.foundation.layout.FlowRow // &lt;-- IMPORT BARU&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import com.example.panicbuttonrtdb.utils.getCurrentLocation // Import fungsi utilitas&#10;&#10;@OptIn(ExperimentalMaterial3Api::class, ExperimentalLayoutApi::class)&#10;@Composable&#10;fun ToggleSwitch(&#10;    viewModel: ViewModel,&#10;    context: Context&#10;) {&#10;&#10;&#10;    var showDialog by remember { mutableStateOf(false) } // State untuk menampilkan dialog&#10;    var pendingToggleState by remember { mutableStateOf(false) } // State untuk menyimpan toggle sementara&#10;    var selectedPriority by remember { mutableStateOf(&quot;Darurat&quot;) }&#10;    var selectedLevel by remember { mutableStateOf(&quot;Darurat&quot;) }&#10;    val buzzerState by viewModel.buzzerState.observeAsState(initial = &quot;off&quot;)&#10;    var message by remember { mutableStateOf(&quot;&quot;) }&#10;    var showError by remember {mutableStateOf(false)}&#10;    var isLoading by remember { mutableStateOf(false) }&#10;&#10;    // 1. Buat Launcher untuk meminta izin&#10;    val locationPermissionLauncher = rememberLauncherForActivityResult(&#10;        contract = ActivityResultContracts.RequestMultiplePermissions(),&#10;        onResult = { permissions -&gt;&#10;            if (permissions.getOrDefault(android.Manifest.permission.ACCESS_FINE_LOCATION, false)) {&#10;                // Izin diberikan, panggil fungsi untuk mendapatkan lokasi dan kirim data&#10;                isLoading = true&#10;                getCurrentLocation(context) { lat, lon -&gt;&#10;                    viewModel.saveMonitorData(&#10;                        message = message,&#10;                        priority = selectedPriority,&#10;                        status = &quot;Proses&quot;,&#10;                        latitude = lat,&#10;                        longitude = lon&#10;                    )&#10;                    val perumahanId = viewModel.getPerumahanId()&#10;&#10;                    viewModel.updateBuzzerState(&#10;                        isOn = true,&#10;                        priority = selectedPriority,&#10;                        level = selectedLevel.lowercase()&#10;                    )&#10;                    sendNotification(&#10;                        context,&#10;                        &quot;Panic Button&quot;,&#10;                        &quot;Buzzer telah diaktifkan dengan skala prioritas $selectedPriority&quot;&#10;                    )&#10;                    showDialog = false&#10;                    isLoading = false&#10;                }&#10;            } else {&#10;                // Izin ditolak, beri tahu user&#10;                Toast.makeText(context, &quot;Izin lokasi dibutuhkan untuk fitur ini&quot;, Toast.LENGTH_SHORT).show()&#10;            }&#10;        }&#10;    )&#10;&#10;&#10;    Column(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .padding(8.dp),&#10;        verticalArrangement = Arrangement.Center,&#10;        horizontalAlignment = Alignment.CenterHorizontally&#10;    ) {&#10;&#10;        Switch(&#10;            checked = buzzerState == &quot;on&quot;,&#10;            onCheckedChange = { isChecked -&gt;&#10;                if (isChecked) {&#10;                    pendingToggleState = true&#10;                    showDialog = true&#10;                } else {&#10;                    // Gunakan satu sumber kebenaran: updateBuzzerState dengan isOn = false&#10;                    viewModel.updateBuzzerState(isOn = false)&#10;                }&#10;            },&#10;            thumbContent = {&#10;                if (buzzerState == &quot;on&quot;) {&#10;                    Icon(&#10;                        painter = painterResource(id = R.drawable.onmode),&#10;                        contentDescription = &quot;on mode&quot;,&#10;                        modifier = Modifier&#10;                            .padding(5.dp),&#10;                        tint = Color.White&#10;                    )&#10;                } else {&#10;                    Icon(&#10;                        painter = painterResource(id = R.drawable.offmode),&#10;                        contentDescription = &quot;off mode&quot;,&#10;                        modifier = Modifier&#10;                            .padding(5.dp)&#10;                            .size(24.dp),&#10;                        tint = Color.White&#10;                    )&#10;                }&#10;            },&#10;            colors = SwitchDefaults.colors(&#10;                checkedTrackColor = colorResource(id = R.color.pudar),&#10;                uncheckedTrackColor = colorResource(id = R.color.merah_pudar),&#10;                uncheckedBorderColor = colorResource(id = R.color.primary),&#10;                checkedThumbColor = colorResource(id = R.color.biru),&#10;                uncheckedThumbColor = colorResource(id = R.color.primary),&#10;                checkedBorderColor = colorResource(id = R.color.biru)&#10;            ),&#10;            modifier = Modifier&#10;                .scale(1.8f)&#10;                .padding(20.dp)&#10;        )&#10;    }&#10;    // Auto-OFF setelah 30 detik menggunakan fungsi OFF yang sama&#10;    if (buzzerState == &quot;on&quot;) {&#10;        LaunchedEffect(key1 = buzzerState) {&#10;            delay(30000)&#10;            viewModel.updateBuzzerState(isOn = false)&#10;        }&#10;    }&#10;    if (showDialog) {&#10;        AlertDialog(&#10;            onDismissRequest = { showDialog = false },&#10;            title = {&#10;                Row(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth(),&#10;                    horizontalArrangement = Arrangement.spacedBy(4.dp),&#10;                    verticalAlignment = Alignment.CenterVertically&#10;                ) {&#10;                    Icon(&#10;                        painter = painterResource(id = R.drawable.ic_warning),&#10;                        contentDescription = &quot;ic warning&quot;,&#10;                        tint = colorResource(id = R.color.darurat)&#10;                    )&#10;                    Text(&#10;                        text = &quot;Konfirmasi&quot;,&#10;                        fontSize = 16.sp,&#10;                        fontWeight = FontWeight.Medium,&#10;                        color = colorResource(id = R.color.primary)&#10;                    )&#10;                }&#10;            },&#10;            text = {&#10;                val quickMessages = listOf(&quot;Kebakaran&quot;, &quot;Bantuan Medis&quot;, &quot;Kerumunan Tidak Wajar&quot;, &quot;Hewan Berbahaya&quot;, &quot;Tolong Segera Datang&quot;, &quot;Kemalingan&quot;)&#10;                Column {&#10;                    Text(&#10;                        &quot;Tambahkan Pesan dan Prioritas&quot;,&#10;                        color = colorResource(id = R.color.font2)&#10;                    )&#10;                    Spacer(modifier = Modifier.height(4.dp))&#10;                    Spacer(modifier = Modifier.height(16.dp)) // &lt;-- BARU&#10;&#10;                    Text(&quot;Quick Massage:&quot;, fontSize = 12.sp, color = colorResource(id = R.color.font2)) // &lt;-- BARU&#10;                    Spacer(modifier = Modifier.height(4.dp)) // &lt;-- BARU&#10;                    FlowRow(&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        horizontalArrangement = Arrangement.spacedBy(8.dp), // Jarak antar tombol&#10;                        verticalArrangement = Arrangement.spacedBy(4.dp)   // Jarak jika ada baris baru&#10;                    ) {&#10;                        quickMessages.forEach { quickMsg -&gt;&#10;                            Button(&#10;                                onClick = { message = quickMsg },&#10;                                shape = RoundedCornerShape(8.dp),&#10;                                colors = ButtonDefaults.buttonColors(&#10;                                    containerColor = colorResource(id = R.color.background_button)&#10;                                ),&#10;                                contentPadding = PaddingValues(horizontal = 12.dp, vertical = 8.dp)&#10;                            ) {&#10;                                Text(text = quickMsg, fontSize = 11.sp, color = colorResource(id = R.color.font2))&#10;                            }&#10;                        }&#10;                    }&#10;                    Spacer(modifier = Modifier.height(16.dp))&#10;                    OutlinedTextField(&#10;                        value = message,&#10;                        onValueChange = { message = it },&#10;                        label = { Text(text = &quot;Tambahkan Pesan&quot;, color = colorResource(id = R.color.font2)) },&#10;                        placeholder = { Text( &quot;Opsional&quot;, color = colorResource(id = R.color.font3)) },&#10;                        colors = TextFieldDefaults.outlinedTextFieldColors(&#10;                            focusedBorderColor = colorResource(id = R.color.font),&#10;                            focusedLabelColor = colorResource(id = R.color.font),&#10;                            cursorColor = colorResource(id = R.color.font)&#10;                        )&#10;                    )&#10;                    PriorityButton(&#10;                        onPrioritySelected = { priority, level -&gt;&#10;                            selectedPriority = priority&#10;                            selectedLevel = level    // bikin variable ini di atas&#10;                        }&#10;                    )&#10;                    if (showError) {&#10;                        Text(&#10;                            text = &quot;Silahkan pilih tombol skala prioritas&quot;,&#10;                            color = colorResource(id = R.color.darurat),&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            modifier = Modifier.padding(top = 8.dp)&#10;                        )&#10;                    }&#10;                }&#10;            },&#10;            containerColor = Color.White,&#10;            confirmButton = {&#10;                Button(&#10;                    modifier = Modifier&#10;                        .width(130.dp),&#10;                    onClick = {&#10;                        if (selectedPriority.isEmpty()) {&#10;                            showError = true&#10;                        } else {&#10;                            showError = false&#10;                            val vibrator = context.getSystemService(Context.VIBRATOR_SERVICE) as Vibrator&#10;                            vibrator.vibrate(VibrationEffect.createOneShot(200, VibrationEffect.DEFAULT_AMPLITUDE))&#10;&#10;                            // Cukup panggil launcher untuk meminta izin.&#10;                            // Sisanya akan diurus oleh onResult dari launcher.&#10;                            locationPermissionLauncher.launch(arrayOf(&#10;                                android.Manifest.permission.ACCESS_FINE_LOCATION,&#10;                                android.Manifest.permission.ACCESS_COARSE_LOCATION&#10;                            ))&#10;                        }&#10;                    },&#10;                    colors = ButtonDefaults.buttonColors(&#10;                        containerColor = colorResource(id = R.color.primary)&#10;                    )&#10;                ) {&#10;                    Text(&#10;                        &quot;Kirim&quot;,&#10;                        color = Color.White&#10;                    )&#10;                }&#10;            },&#10;            dismissButton = {&#10;                Button(&#10;                    modifier = Modifier&#10;                        .width(130.dp),&#10;                    onClick = { showDialog = false },&#10;                    colors = ButtonDefaults.buttonColors(&#10;                        containerColor = colorResource(id = R.color.background_button)&#10;                    )&#10;                ) {&#10;                    Text(&#10;                        &quot;Batal&quot;,&#10;                        color = colorResource(id = R.color.font3)&#10;                    )&#10;                }&#10;            }&#10;        )&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.panicbuttonrtdb.prensentation.components&#13;&#10;&#13;&#10;import android.content.Context&#13;&#10;import android.os.VibrationEffect&#13;&#10;import android.os.Vibrator&#13;&#10;import android.util.Log&#13;&#10;import android.widget.Toast&#13;&#10;import androidx.compose.foundation.layout.Arrangement&#13;&#10;import androidx.compose.foundation.layout.Column&#13;&#10;import androidx.compose.foundation.layout.Row&#13;&#10;import androidx.compose.foundation.layout.Spacer&#13;&#10;import androidx.compose.foundation.layout.fillMaxWidth&#13;&#10;import androidx.compose.foundation.layout.height&#13;&#10;import androidx.compose.foundation.layout.padding&#13;&#10;import androidx.compose.foundation.layout.size&#13;&#10;import androidx.compose.foundation.layout.width&#13;&#10;import androidx.compose.material3.AlertDialog&#13;&#10;import androidx.compose.material3.Button&#13;&#10;import androidx.compose.material3.ButtonDefaults&#13;&#10;import androidx.compose.material3.ExperimentalMaterial3Api&#13;&#10;import androidx.compose.material3.Icon&#13;&#10;import androidx.compose.material3.MaterialTheme&#13;&#10;import androidx.compose.material3.OutlinedTextField&#13;&#10;import androidx.compose.material3.Switch&#13;&#10;import androidx.compose.material3.SwitchDefaults&#13;&#10;import androidx.compose.material3.Text&#13;&#10;import androidx.compose.material3.TextFieldDefaults&#13;&#10;import androidx.compose.runtime.Composable&#13;&#10;import androidx.compose.runtime.LaunchedEffect&#13;&#10;import androidx.compose.runtime.getValue&#13;&#10;import androidx.compose.runtime.livedata.observeAsState&#13;&#10;import androidx.compose.runtime.mutableStateOf&#13;&#10;import androidx.compose.runtime.remember&#13;&#10;import androidx.compose.runtime.setValue&#13;&#10;import androidx.compose.ui.Alignment&#13;&#10;import androidx.compose.ui.Modifier&#13;&#10;import androidx.compose.ui.draw.scale&#13;&#10;import androidx.compose.ui.graphics.Color&#13;&#10;import androidx.compose.ui.platform.LocalContext&#13;&#10;import androidx.compose.ui.res.colorResource&#13;&#10;import androidx.compose.ui.res.painterResource&#13;&#10;import androidx.compose.ui.text.font.FontWeight&#13;&#10;import androidx.compose.ui.unit.dp&#13;&#10;import androidx.compose.ui.unit.sp&#13;&#10;import com.example.panicbuttonrtdb.R&#13;&#10;import com.example.panicbuttonrtdb.notification.sendNotification&#13;&#10;import com.example.panicbuttonrtdb.viewmodel.ViewModel&#13;&#10;import kotlinx.coroutines.delay&#13;&#10;import androidx.compose.foundation.layout.PaddingValues&#13;&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#13;&#10;import androidx.compose.foundation.layout.ExperimentalLayoutApi&#13;&#10;import androidx.compose.foundation.layout.FlowRow&#13;&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#13;&#10;import androidx.activity.result.contract.ActivityResultContracts&#13;&#10;import com.example.panicbuttonrtdb.utils.getCurrentLocation&#13;&#10;&#13;&#10;@OptIn(ExperimentalMaterial3Api::class, ExperimentalLayoutApi::class)&#13;&#10;@Composable&#13;&#10;fun ToggleSwitch(&#13;&#10;    viewModel: ViewModel,&#13;&#10;    context: Context&#13;&#10;) {&#13;&#10;    var showDialog by remember { mutableStateOf(false) }&#13;&#10;    var pendingToggleState by remember { mutableStateOf(false) }&#13;&#10;    var selectedPriority by remember { mutableStateOf(&quot;&quot;) }&#13;&#10;    // FIX: selectedLevel HARUS lowercase untuk ESP8266&#13;&#10;    var selectedLevel by remember { mutableStateOf(&quot;&quot;) }&#13;&#10;    val buzzerState by viewModel.buzzerState.observeAsState(initial = &quot;off&quot;)&#13;&#10;    var message by remember { mutableStateOf(&quot;&quot;) }&#13;&#10;    var showError by remember { mutableStateOf(false) }&#13;&#10;    var isLoading by remember { mutableStateOf(false) }&#13;&#10;&#13;&#10;    // FIX: Launcher untuk meminta izin lokasi&#13;&#10;    val locationPermissionLauncher = rememberLauncherForActivityResult(&#13;&#10;        contract = ActivityResultContracts.RequestMultiplePermissions(),&#13;&#10;        onResult = { permissions -&gt;&#13;&#10;            if (permissions.getOrDefault(android.Manifest.permission.ACCESS_FINE_LOCATION, false)) {&#13;&#10;                isLoading = true&#13;&#10;                getCurrentLocation(context) { lat, lon -&gt;&#13;&#10;                    // FIX: Simpan monitor data dengan user dari session aktif&#13;&#10;                    viewModel.saveMonitorData(&#13;&#10;                        message = message,&#13;&#10;                        priority = selectedPriority,&#13;&#10;                        status = &quot;Proses&quot;,&#13;&#10;                        latitude = lat,&#13;&#10;                        longitude = lon&#13;&#10;                    )&#13;&#10;                    &#13;&#10;                    val perumahanId = viewModel.getPerumahanId()&#13;&#10;&#13;&#10;                    // FIX: Gunakan HANYA updateBuzzerState dengan level lowercase&#13;&#10;                    viewModel.updateBuzzerState(&#13;&#10;                        isOn = true,&#13;&#10;                        priority = selectedPriority,&#13;&#10;                        level = selectedLevel.lowercase()&#13;&#10;                    )&#13;&#10;                    &#13;&#10;                    sendNotification(&#13;&#10;                        context,&#13;&#10;                        &quot;Panic Button&quot;,&#13;&#10;                        &quot;Buzzer telah diaktifkan dengan skala prioritas $selectedPriority&quot;&#13;&#10;                    )&#13;&#10;                    showDialog = false&#13;&#10;                    isLoading = false&#13;&#10;                    &#13;&#10;                    // Reset nilai untuk penggunaan berikutnya&#13;&#10;                    message = &quot;&quot;&#13;&#10;                    selectedPriority = &quot;&quot;&#13;&#10;                    selectedLevel = &quot;&quot;&#13;&#10;                }&#13;&#10;            } else {&#13;&#10;                Toast.makeText(context, &quot;Izin lokasi dibutuhkan untuk fitur ini&quot;, Toast.LENGTH_SHORT).show()&#13;&#10;                isLoading = false&#13;&#10;            }&#13;&#10;        }&#13;&#10;    )&#13;&#10;&#13;&#10;    Column(&#13;&#10;        modifier = Modifier&#13;&#10;            .fillMaxWidth()&#13;&#10;            .padding(8.dp),&#13;&#10;        verticalArrangement = Arrangement.Center,&#13;&#10;        horizontalAlignment = Alignment.CenterHorizontally&#13;&#10;    ) {&#13;&#10;        Switch(&#13;&#10;            checked = buzzerState == &quot;on&quot;,&#13;&#10;            onCheckedChange = { isChecked -&gt;&#13;&#10;                if (isChecked) {&#13;&#10;                    // FIX: ON - tampilkan dialog konfirmasi&#13;&#10;                    pendingToggleState = true&#13;&#10;                    showDialog = true&#13;&#10;                } else {&#13;&#10;                    // FIX: OFF - langsung update Firebase dengan state=off dan level=off&#13;&#10;                    viewModel.updateBuzzerState(isOn = false)&#13;&#10;                    Log.d(&quot;ToggleSwitch&quot;, &quot;Manual OFF: state=off, level=off&quot;)&#13;&#10;                }&#13;&#10;            },&#13;&#10;            thumbContent = {&#13;&#10;                if (buzzerState == &quot;on&quot;) {&#13;&#10;                    Icon(&#13;&#10;                        painter = painterResource(id = R.drawable.onmode),&#13;&#10;                        contentDescription = &quot;on mode&quot;,&#13;&#10;                        modifier = Modifier.padding(5.dp),&#13;&#10;                        tint = Color.White&#13;&#10;                    )&#13;&#10;                } else {&#13;&#10;                    Icon(&#13;&#10;                        painter = painterResource(id = R.drawable.offmode),&#13;&#10;                        contentDescription = &quot;off mode&quot;,&#13;&#10;                        modifier = Modifier&#13;&#10;                            .padding(5.dp)&#13;&#10;                            .size(24.dp),&#13;&#10;                        tint = Color.White&#13;&#10;                    )&#13;&#10;                }&#13;&#10;            },&#13;&#10;            colors = SwitchDefaults.colors(&#13;&#10;                checkedTrackColor = colorResource(id = R.color.pudar),&#13;&#10;                uncheckedTrackColor = colorResource(id = R.color.merah_pudar),&#13;&#10;                uncheckedBorderColor = colorResource(id = R.color.primary),&#13;&#10;                checkedThumbColor = colorResource(id = R.color.biru),&#13;&#10;                uncheckedThumbColor = colorResource(id = R.color.primary),&#13;&#10;                checkedBorderColor = colorResource(id = R.color.biru)&#13;&#10;            ),&#13;&#10;            modifier = Modifier&#13;&#10;                .scale(1.8f)&#13;&#10;                .padding(20.dp)&#13;&#10;        )&#13;&#10;    }&#13;&#10;    &#13;&#10;    // FIX: Auto-OFF setelah 30 detik menggunakan fungsi OFF yang sama&#13;&#10;    if (buzzerState == &quot;on&quot;) {&#13;&#10;        LaunchedEffect(key1 = buzzerState) {&#13;&#10;            delay(30000)&#13;&#10;            // FIX: Gunakan updateBuzzerState untuk konsistensi&#13;&#10;            viewModel.updateBuzzerState(isOn = false)&#13;&#10;            Log.d(&quot;ToggleSwitch&quot;, &quot;Auto-OFF 30s: state=off, level=off&quot;)&#13;&#10;        }&#13;&#10;    }&#13;&#10;    &#13;&#10;    if (showDialog) {&#13;&#10;        AlertDialog(&#13;&#10;            onDismissRequest = { &#13;&#10;                showDialog = false&#13;&#10;                // Reset saat dialog ditutup&#13;&#10;                selectedPriority = &quot;&quot;&#13;&#10;                selectedLevel = &quot;&quot;&#13;&#10;                message = &quot;&quot;&#13;&#10;                showError = false&#13;&#10;            },&#13;&#10;            title = {&#13;&#10;                Row(&#13;&#10;                    modifier = Modifier.fillMaxWidth(),&#13;&#10;                    horizontalArrangement = Arrangement.spacedBy(4.dp),&#13;&#10;                    verticalAlignment = Alignment.CenterVertically&#13;&#10;                ) {&#13;&#10;                    Icon(&#13;&#10;                        painter = painterResource(id = R.drawable.ic_warning),&#13;&#10;                        contentDescription = &quot;ic warning&quot;,&#13;&#10;                        tint = colorResource(id = R.color.darurat)&#13;&#10;                    )&#13;&#10;                    Text(&#13;&#10;                        text = &quot;Konfirmasi&quot;,&#13;&#10;                        fontSize = 16.sp,&#13;&#10;                        fontWeight = FontWeight.Medium,&#13;&#10;                        color = colorResource(id = R.color.primary)&#13;&#10;                    )&#13;&#10;                }&#13;&#10;            },&#13;&#10;            text = {&#13;&#10;                val quickMessages = listOf(&#13;&#10;                    &quot;Kebakaran&quot;, &#13;&#10;                    &quot;Bantuan Medis&quot;, &#13;&#10;                    &quot;Kerumunan Tidak Wajar&quot;, &#13;&#10;                    &quot;Hewan Berbahaya&quot;, &#13;&#10;                    &quot;Tolong Segera Datang&quot;, &#13;&#10;                    &quot;Kemalingan&quot;&#13;&#10;                )&#13;&#10;                Column {&#13;&#10;                    Text(&#13;&#10;                        &quot;Tambahkan Pesan dan Prioritas&quot;,&#13;&#10;                        color = colorResource(id = R.color.font2)&#13;&#10;                    )&#13;&#10;                    Spacer(modifier = Modifier.height(4.dp))&#13;&#10;                    Spacer(modifier = Modifier.height(16.dp))&#13;&#10;&#13;&#10;                    Text(&#13;&#10;                        &quot;Quick Massage:&quot;, &#13;&#10;                        fontSize = 12.sp, &#13;&#10;                        color = colorResource(id = R.color.font2)&#13;&#10;                    )&#13;&#10;                    Spacer(modifier = Modifier.height(4.dp))&#13;&#10;                    FlowRow(&#13;&#10;                        modifier = Modifier.fillMaxWidth(),&#13;&#10;                        horizontalArrangement = Arrangement.spacedBy(8.dp),&#13;&#10;                        verticalArrangement = Arrangement.spacedBy(4.dp)&#13;&#10;                    ) {&#13;&#10;                        quickMessages.forEach { quickMsg -&gt;&#13;&#10;                            Button(&#13;&#10;                                onClick = { message = quickMsg },&#13;&#10;                                shape = RoundedCornerShape(8.dp),&#13;&#10;                                colors = ButtonDefaults.buttonColors(&#13;&#10;                                    containerColor = colorResource(id = R.color.background_button)&#13;&#10;                                ),&#13;&#10;                                contentPadding = PaddingValues(horizontal = 12.dp, vertical = 8.dp)&#13;&#10;                            ) {&#13;&#10;                                Text(&#13;&#10;                                    text = quickMsg, &#13;&#10;                                    fontSize = 11.sp, &#13;&#10;                                    color = colorResource(id = R.color.font2)&#13;&#10;                                )&#13;&#10;                            }&#13;&#10;                        }&#13;&#10;                    }&#13;&#10;                    Spacer(modifier = Modifier.height(16.dp))&#13;&#10;                    OutlinedTextField(&#13;&#10;                        value = message,&#13;&#10;                        onValueChange = { message = it },&#13;&#10;                        label = { &#13;&#10;                            Text(&#13;&#10;                                text = &quot;Tambahkan Pesan&quot;, &#13;&#10;                                color = colorResource(id = R.color.font2)&#13;&#10;                            ) &#13;&#10;                        },&#13;&#10;                        placeholder = { &#13;&#10;                            Text(&#13;&#10;                                &quot;Opsional&quot;, &#13;&#10;                                color = colorResource(id = R.color.font3)&#13;&#10;                            ) &#13;&#10;                        },&#13;&#10;                        colors = TextFieldDefaults.outlinedTextFieldColors(&#13;&#10;                            focusedBorderColor = colorResource(id = R.color.font),&#13;&#10;                            focusedLabelColor = colorResource(id = R.color.font),&#13;&#10;                            cursorColor = colorResource(id = R.color.font)&#13;&#10;                        )&#13;&#10;                    )&#13;&#10;                    &#13;&#10;                    // FIX: PriorityButton harus mengembalikan level lowercase&#13;&#10;                    PriorityButton(&#13;&#10;                        onPrioritySelected = { priority, level -&gt;&#13;&#10;                            selectedPriority = priority&#13;&#10;                            // FIX: Pastikan level lowercase untuk ESP8266&#13;&#10;                            selectedLevel = level.lowercase()&#13;&#10;                            showError = false&#13;&#10;                        }&#13;&#10;                    )&#13;&#10;                    &#13;&#10;                    if (showError) {&#13;&#10;                        Text(&#13;&#10;                            text = &quot;Silahkan pilih tombol skala prioritas&quot;,&#13;&#10;                            color = colorResource(id = R.color.darurat),&#13;&#10;                            style = MaterialTheme.typography.bodySmall,&#13;&#10;                            modifier = Modifier.padding(top = 8.dp)&#13;&#10;                        )&#13;&#10;                    }&#13;&#10;                }&#13;&#10;            },&#13;&#10;            containerColor = Color.White,&#13;&#10;            confirmButton = {&#13;&#10;                Button(&#13;&#10;                    modifier = Modifier.width(130.dp),&#13;&#10;                    onClick = {&#13;&#10;                        if (selectedPriority.isEmpty() || selectedLevel.isEmpty()) {&#13;&#10;                            showError = true&#13;&#10;                        } else {&#13;&#10;                            showError = false&#13;&#10;                            val vibrator = context.getSystemService(Context.VIBRATOR_SERVICE) as Vibrator&#13;&#10;                            vibrator.vibrate(&#13;&#10;                                VibrationEffect.createOneShot(200, VibrationEffect.DEFAULT_AMPLITUDE)&#13;&#10;                            )&#13;&#10;&#13;&#10;                            // FIX: Request permission, proses di callback&#13;&#10;                            locationPermissionLauncher.launch(&#13;&#10;                                arrayOf(&#13;&#10;                                    android.Manifest.permission.ACCESS_FINE_LOCATION,&#13;&#10;                                    android.Manifest.permission.ACCESS_COARSE_LOCATION&#13;&#10;                                )&#13;&#10;                            )&#13;&#10;                        }&#13;&#10;                    },&#13;&#10;                    colors = ButtonDefaults.buttonColors(&#13;&#10;                        containerColor = colorResource(id = R.color.primary)&#13;&#10;                    ),&#13;&#10;                    enabled = !isLoading&#13;&#10;                ) {&#13;&#10;                    Text(&#13;&#10;                        if (isLoading) &quot;Mengirim...&quot; else &quot;Kirim&quot;,&#13;&#10;                        color = Color.White&#13;&#10;                    )&#13;&#10;                }&#13;&#10;            },&#13;&#10;            dismissButton = {&#13;&#10;                Button(&#13;&#10;                    modifier = Modifier.width(130.dp),&#13;&#10;                    onClick = { &#13;&#10;                        showDialog = false&#13;&#10;                        selectedPriority = &quot;&quot;&#13;&#10;                        selectedLevel = &quot;&quot;&#13;&#10;                        message = &quot;&quot;&#13;&#10;                        showError = false&#13;&#10;                    },&#13;&#10;                    colors = ButtonDefaults.buttonColors(&#13;&#10;                        containerColor = colorResource(id = R.color.background_button)&#13;&#10;                    ),&#13;&#10;                    enabled = !isLoading&#13;&#10;                ) {&#13;&#10;                    Text(&#13;&#10;                        &quot;Batal&quot;,&#13;&#10;                        color = colorResource(id = R.color.font3)&#13;&#10;                    )&#13;&#10;                }&#13;&#10;            }&#13;&#10;        )&#13;&#10;    }&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/panicbuttonrtdb/viewmodel/ViewModel.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/panicbuttonrtdb/viewmodel/ViewModel.kt" />
              <option name="originalContent" value="package com.example.panicbuttonrtdb.viewmodel&#10;&#10;import android.content.Context&#10;import android.net.Uri&#10;import android.util.Log&#10;import android.widget.Toast&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.setValue&#10;import androidx.lifecycle.LiveData&#10;import androidx.lifecycle.MutableLiveData&#10;import androidx.lifecycle.ViewModel&#10;import androidx.lifecycle.viewModelScope&#10;import com.example.panicbuttonrtdb.data.MonitorRecord&#10;import com.example.panicbuttonrtdb.data.User&#10;import com.example.panicbuttonrtdb.data.UserPreferences&#10;import com.google.firebase.database.DataSnapshot&#10;import com.google.firebase.database.DatabaseError&#10;import com.google.firebase.database.FirebaseDatabase&#10;import com.google.firebase.database.ValueEventListener&#10;import com.google.firebase.storage.FirebaseStorage&#10;import kotlinx.coroutines.flow.MutableStateFlow&#10;import kotlinx.coroutines.flow.StateFlow&#10;import kotlinx.coroutines.launch&#10;&#10;open class ViewModel(private val context: Context) : ViewModel() {&#10;&#10;    private val database = FirebaseDatabase.getInstance()&#10;    private val storage = FirebaseStorage.getInstance().reference&#10;    private val userPreferences = UserPreferences(context)&#10;    private val monitorRef = database.getReference(&quot;monitor&quot;)&#10;    private val usersRef = database.getReference(&quot;users&quot;)&#10;&#10;    var currentUserName by mutableStateOf(&quot;&quot;)&#10;    var currentUserHouseNumber by mutableStateOf(&quot;&quot;)&#10;&#10;    private val _monitorData = MutableLiveData&lt;List&lt;MonitorRecord&gt;&gt;()&#10;    val monitorData: LiveData&lt;List&lt;MonitorRecord&gt;&gt; get() = _monitorData&#10;&#10;    private val _userData = MutableLiveData&lt;Map&lt;String, String&gt;&gt;()&#10;    val userData: LiveData&lt;Map&lt;String, String&gt;&gt; get() = _userData&#10;&#10;    private val _latestRecord = MutableStateFlow(MonitorRecord())&#10;    val latestRecord: StateFlow&lt;MonitorRecord&gt; = _latestRecord&#10;&#10;    // LiveData untuk memantau status buzzer&#10;    private val _buzzerState = MutableLiveData&lt;String&gt;()&#10;    val buzzerState: LiveData&lt;String&gt; = _buzzerState&#10;&#10;    init {&#10;        // Ambil data pengguna yang tersimpan saat aplikasi dibuka kembali&#10;        currentUserName = userPreferences.getUserName() ?: &quot;&quot;&#10;        currentUserHouseNumber = userPreferences.getHouseNumber() ?: &quot;&quot;&#10;&#10;        fetchLatestRecord()&#10;&#10;        // Inisialisasi untuk mendapatkan status awal buzzer dari Firebase&#10;        getBuzzerState()&#10;    }&#10;&#10;    fun isUserLoggedIn(): Boolean {&#10;        return userPreferences.isUserLoggedIn()&#10;    }&#10;&#10;    fun isAdminLoggedIn(): Boolean {&#10;        return userPreferences.isAdminLoggedIn()&#10;    }&#10;&#10;    // Fungsi untuk menyimpan user baru ke Firebase&#10;    fun saveUserToFirebase(&#10;        name: String,&#10;        houseNumber: String,&#10;        password: String,&#10;        onSuccess: () -&gt; Unit,&#10;        onFailure: (String) -&gt; Unit,  // Tambahkan callback untuk error&#10;        perumahanId: String? = null&#10;&#10;    ) {&#10;&#10;        // Periksa apakah sudah ada pengguna dengan nomor rumah atau nama yang sama&#10;        // Use the appropriate users reference depending on perumahanId&#10;        val targetRef = if (!perumahanId.isNullOrEmpty()) {&#10;            database.getReference(&quot;perumahan&quot;).child(perumahanId).child(&quot;users&quot;)&#10;        } else {&#10;            usersRef&#10;        }&#10;&#10;        targetRef.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        // Jika nomor rumah sudah ada&#10;                        onFailure(&quot;Nomor rumah sudah digunakan.&quot;)&#10;                        Toast.makeText(context, &quot;Nomor rumah sudah digunakan&quot;, Toast.LENGTH_SHORT).show()&#10;                    } else {&#10;                        // Lakukan pengecekan untuk nama&#10;                        targetRef.orderByChild(&quot;name&quot;).equalTo(name)&#10;                            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                                override fun onDataChange(snapshot: DataSnapshot) {&#10;                                    if (snapshot.exists()) {&#10;                                        // Jika nama sudah ada&#10;                                        onFailure(&quot;Nama sudah digunakan.&quot;)&#10;                                        Toast.makeText(context, &quot;Nama sudah digunakan&quot;, Toast.LENGTH_SHORT).show()&#10;                                    } else {&#10;                                        // Jika tidak ada duplikasi, simpan data pengguna&#10;                                        val userId = targetRef.push().key // Buat key unik untuk user baru&#10;                                        val user = User(name, houseNumber, password)&#10;&#10;                                        userId?.let {&#10;                                            targetRef.child(it).setValue(user)&#10;                                                .addOnCompleteListener { task -&gt;&#10;                                                    if (task.isSuccessful) {&#10;                                                        onSuccess() // Data berhasil disimpan&#10;                                                        Toast.makeText(context, &quot;Sign Up Berhasil&quot;, Toast.LENGTH_SHORT).show()&#10;                                                    } else {&#10;                                                        onFailure(&quot;Gagal menyimpan data.&quot;)&#10;                                                    }&#10;                                                }&#10;                                        }&#10;                                    }&#10;                                }&#10;&#10;                                override fun onCancelled(error: DatabaseError) {&#10;                                    onFailure(&quot;Terjadi kesalahan: ${error.message}&quot;)&#10;                                }&#10;                            })&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    onFailure(&quot;Terjadi kesalahan: ${error.message}&quot;)&#10;                }&#10;            })&#10;&#10;    }&#10;&#10;    // Fungsi untuk validasi login&#10;    // Kotlin&#10;// File: `app/src/main/java/com/example/panicbuttonrtdb/viewmodel/ViewModel.kt`&#10;// Replace the existing validateLogin function with this implementation.&#10;&#10;    fun validateLogin(houseNumber: String, password: String, onResult: (Boolean, Boolean) -&gt; Unit) {&#10;        // Admin credentials (unchanged)&#10;        val adminHouseNumber = &quot;admin&quot;&#10;        val adminPassword = &quot;admin&quot;&#10;&#10;        if (houseNumber == adminHouseNumber &amp;&amp; password == adminPassword) {&#10;            userPreferences.saveAdminLoggedIn(true)&#10;            onResult(true, true)&#10;            return&#10;        }&#10;&#10;        // Get selected perumahan id from preferences&#10;        val perumahanId = userPreferences.getPerumahanId() ?: &quot;&quot;&#10;        if (perumahanId.isEmpty()) {&#10;            onResult(false, false)&#10;            return&#10;        }&#10;&#10;        // Path sesuai struktur kamu:&#10;        // perumahan/{perumahanId}/users&#10;        val usersRef = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;users&quot;)&#10;&#10;        // Cari user berdasarkan houseNumber&#10;        usersRef.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;&#10;                    if (!snapshot.exists()) {&#10;                        onResult(false, false)&#10;                        return&#10;                    }&#10;&#10;                    for (child in snapshot.children) {&#10;                        val user = child.getValue(User::class.java)&#10;&#10;                        if (user != null &amp;&amp; user.password == password) {&#10;&#10;                            userPreferences.saveUserLoggedIn(true)&#10;                            userPreferences.saveUserInfo(user.name, user.houseNumber)&#10;&#10;                            currentUserName = user.name&#10;                            currentUserHouseNumber = user.houseNumber&#10;&#10;                            onResult(true, false)&#10;                            return&#10;                        }&#10;                    }&#10;&#10;                    onResult(false, false)&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    onResult(false, false)&#10;                }&#10;            })&#10;    }&#10;&#10;    // Fungsi untuk logout&#10;    fun logout() {&#10;        // Menghapus status login dari SharedPreferences&#10;        userPreferences.saveUserLoggedIn(false)&#10;        currentUserName = &quot;&quot; // Reset nama pengguna saat logout&#10;        currentUserHouseNumber = &quot;&quot; // Reset nomor rumah saat logout&#10;    }&#10;&#10;    fun adminLogout() {&#10;        userPreferences.saveAdminLoggedIn(false)&#10;        userPreferences.clearUserInfo()&#10;    }&#10;&#10;    // Fungsi untuk menyimpan data ke path /monitor di Firebase&#10;    fun saveMonitorData(&#10;        message: String,&#10;        priority: String,&#10;        status: String,&#10;        latitude: Double,&#10;        longitude: Double&#10;    ) {&#10;        // Selalu ambil nama &amp; nomor rumah TERKINI dari UserPreferences&#10;        val latestName = userPreferences.getUserName() ?: &quot;&quot;&#10;        val latestHouseNumber = userPreferences.getHouseNumber() ?: &quot;&quot;&#10;&#10;        currentUserName = latestName&#10;        currentUserHouseNumber = latestHouseNumber&#10;&#10;        val data = mapOf(&#10;            &quot;name&quot; to latestName,&#10;            &quot;houseNumber&quot; to latestHouseNumber,&#10;            &quot;message&quot; to message,&#10;            &quot;priority&quot; to priority,&#10;            &quot;status&quot; to status,&#10;            &quot;time&quot; to getCurrentTimestampFormatted(),&#10;            &quot;latitude&quot; to latitude,&#10;            &quot;longitude&quot; to longitude&#10;        )&#10;&#10;        // Simpan data ke Firebase&#10;        monitorRef.push().setValue(data)&#10;            .addOnCompleteListener { task -&gt;&#10;                if (task.isSuccessful) {&#10;                    Log.d(&quot;Firebase&quot;, &quot;Data berhasil disimpan ke /monitor&quot;)&#10;                } else {&#10;                    Log.e(&quot;Firebase&quot;, &quot;Gagal menyimpan data&quot;, task.exception)&#10;                }&#10;            }&#10;    }&#10;&#10;    // Fungsi untuk mendapatkan status buzzer dari Firebase&#10;    private fun getBuzzerState() {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) {&#10;            _buzzerState.value = &quot;off&quot;&#10;            return&#10;        }&#10;&#10;        val stateRef = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;buzzers&quot;)&#10;            .child(&quot;main&quot;)&#10;            .child(&quot;state&quot;)&#10;&#10;        stateRef.addValueEventListener(object : ValueEventListener {&#10;            override fun onDataChange(snapshot: DataSnapshot) {&#10;                val state = snapshot.getValue(String::class.java) ?: &quot;off&quot;&#10;                _buzzerState.value = state&#10;            }&#10;&#10;            override fun onCancelled(error: DatabaseError) {&#10;                Log.e(&quot;Firebase&quot;, &quot;getBuzzerState cancelled: ${error.message}&quot;)&#10;            }&#10;        })&#10;    }&#10;&#10;    // Satu-satunya fungsi penulisan alarm ke node baru&#10;    fun updateAlarmForPerumahan(perumahanId: String, state: String, level: String) {&#10;        if (perumahanId.isEmpty()) {&#10;            Log.e(&quot;Firebase&quot;, &quot;updateAlarmForPerumahan: perumahanId kosong&quot;)&#10;            return&#10;        }&#10;&#10;        val baseRef = database&#10;            .getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;buzzers&quot;)&#10;            .child(&quot;main&quot;)&#10;&#10;        val data = mapOf(&#10;            &quot;state&quot; to state,&#10;            &quot;level&quot; to level&#10;        )&#10;&#10;        baseRef.setValue(data)&#10;            .addOnSuccessListener {&#10;                Log.d(&quot;Firebase&quot;, &quot;Alarm updated: $data&quot;)&#10;            }&#10;            .addOnFailureListener {&#10;                Log.e(&quot;Firebase&quot;, &quot;ERROR update alarm: ${it.message}&quot;)&#10;            }&#10;    }&#10;&#10;    // Fungsi helper lama diarahkan ke struktur baru&#10;    fun setBuzzerState(state: String) {&#10;        val perumahanId = getPerumahanId()&#10;        val level = if (state == &quot;on&quot;) &quot;biasa&quot; else &quot;off&quot;&#10;        updateAlarmForPerumahan(perumahanId, state, level)&#10;    }&#10;&#10;    // Refactor: gunakan updateAlarmForPerumahan sebagai sumber kebenaran tunggal&#10;    fun updateBuzzerState(isOn: Boolean, priority: String? = null, level: String? = null) {&#10;        val perumahanId = getPerumahanId()&#10;&#10;        if (!isOn) {&#10;            // OFF: state dan level harus &quot;off&quot;&#10;            updateAlarmForPerumahan(&#10;                perumahanId = perumahanId,&#10;                state = &quot;off&quot;,&#10;                level = &quot;off&quot;&#10;            )&#10;            return&#10;        }&#10;&#10;        // ON: gunakan level sesuai prioritas yang dikirim&#10;        val finalLevel = level ?: &quot;biasa&quot;&#10;&#10;        updateAlarmForPerumahan(&#10;            perumahanId = perumahanId,&#10;            state = &quot;on&quot;,&#10;            level = finalLevel&#10;        )&#10;    }&#10;&#10;    fun fetchMonitorData() {&#10;        monitorRef.addValueEventListener(object : ValueEventListener {&#10;            override fun onDataChange(snapshot: DataSnapshot) {&#10;                val records = mutableListOf&lt;MonitorRecord&gt;()&#10;                for (recordSnapshot in snapshot.children.reversed()) {&#10;                    val record = recordSnapshot.getValue(MonitorRecord::class.java)&#10;                    record?.let { records.add(it) }&#10;                }&#10;                _monitorData.value = records&#10;            }&#10;&#10;            override fun onCancelled(error: DatabaseError) {&#10;                Log.e(&quot;Firebase&quot;, &quot;Failed to fetch monitor data&quot;, error.toException())&#10;            }&#10;        })&#10;    }&#10;&#10;    fun fetchLatestRecord() {&#10;        monitorRef.orderByKey().limitToLast(1)&#10;            .addValueEventListener(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        val data = snapshot.children.first().getValue(MonitorRecord::class.java)&#10;                        data?.let {&#10;                            viewModelScope.launch {&#10;                                _latestRecord.emit(it)&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    // Handle error&#10;                }&#10;            })&#10;    }&#10;&#10;&#10;    // fun menampilkan 3 data&#10;    fun latestMonitorItem() {&#10;        monitorRef.orderByKey().limitToLast(3) // take 3 data terbaru&#10;            .addValueEventListener(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    val records = mutableListOf&lt;MonitorRecord&gt;()&#10;&#10;                    for (recordSnapshot in snapshot.children.reversed()) {&#10;                        val record = recordSnapshot.getValue(MonitorRecord::class.java)&#10;                        record?.let { records.add(it)&#10;&#10;                        }&#10;&#10;                        _monitorData.value = records&#10;                    }&#10;&#10;                    _monitorData.value = records // take 3 data&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Log.e(&quot;Firebase&quot;, &quot;Failed to fetch monitor data&quot;, error.toException())&#10;                }&#10;            })&#10;    }&#10;&#10;&#10;    // Fungsi untuk menampilkan detail rekap berdasarkan nomor rumah&#10;    fun detailRekap(houseNumber: String) {&#10;        monitorRef.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    val records = snapshot.children.reversed().mapNotNull { recordSnapshot -&gt; //take data&#10;                        recordSnapshot.getValue(MonitorRecord::class.java)?.copy(id = recordSnapshot.key ?: &quot;&quot;) //menetapkan id = key&#10;                    }&#10;                    (records.isNotEmpty()) //check apakah records kosong&#10;                    _monitorData.value = records //jika records tdk kosong update _monitorData&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Log.e(&quot;detailRekap&quot;, &quot;gagal mengambil data&quot;, error.toException())&#10;                }&#10;            })&#10;    }&#10;&#10;    //fun utk menampilkan riwayat user berdasarkan houseNumber&#10;    fun userHistory() {&#10;        monitorRef.addValueEventListener(object : ValueEventListener {&#10;            override fun onDataChange(snapshot: DataSnapshot) {&#10;                val records = mutableListOf&lt;MonitorRecord&gt;()&#10;&#10;                for (recordSnapshot in snapshot.children.reversed()){ //reversed utk mengurutkan data dari yang terbaru&#10;                    val record = recordSnapshot.getValue(MonitorRecord::class.java)&#10;                    if (record?.houseNumber == currentUserHouseNumber) {&#10;                        records.add(record)&#10;                    }&#10;                }&#10;                _monitorData.value = records //hanya utk data yang sesuai dengan houseNumber&#10;            }&#10;&#10;            override fun onCancelled(error: DatabaseError) {&#10;                Log.e(&quot;Firebase&quot;,&quot;Gagal mengambil data&quot;, error.toException())&#10;            }&#10;        })&#10;    }&#10;&#10;    //fun upload foto ke storage&#10;    fun uploadImage(imageUri: Uri, houseNumber: String, imageType: String, context: Context) {&#10;        val imageRef = storage.child(&quot;${imageType}/$houseNumber.jpg&quot;)&#10;&#10;        imageRef.putFile(imageUri)&#10;            .addOnSuccessListener {&#10;                imageRef.downloadUrl.addOnSuccessListener { uri -&gt;&#10;                    saveImagePathToDatabase(uri.toString(), houseNumber, imageType, context)&#10;                }&#10;            }&#10;    }&#10;&#10;    //funtion utk simpan path foto ke database&#10;    private fun saveImagePathToDatabase(imageUri: String, houseNumber: String, imageType: String, context: Context) {&#10;&#10;        usersRef.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        for (userSnapshot in snapshot.children) {&#10;                            userSnapshot.ref.child(imageType).setValue(imageUri)&#10;                                .addOnSuccessListener {&#10;                                    Toast.makeText(context, &quot;$imageType berhasil di diperbaharui. Tunggu beberapa saat&quot;, Toast.LENGTH_SHORT).show()&#10;                                }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Toast.makeText(context, &quot;Error: ${error.message}&quot;, Toast.LENGTH_SHORT).show()&#10;                }&#10;            })&#10;    }&#10;&#10;    //fun update status pesan&#10;    fun updateStatus(recordId: String) {&#10;        monitorRef.child(recordId).child(&quot;status&quot;).setValue(&quot;Selesai&quot;) //update data di status&#10;&#10;    }&#10;&#10;    // fun utk save no hp &amp; note user&#10;    fun savePhoneNumberAndNote(houseNumber: String, phoneNumber: String, note: String) {&#10;        usersRef.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        for (child in snapshot.children) {&#10;                            child.ref.child(&quot;phoneNumber&quot;).setValue(phoneNumber)&#10;                            child.ref.child(&quot;note&quot;).setValue(note)&#10;                                .addOnCompleteListener { task -&gt;&#10;                                    if (task.isSuccessful) {&#10;                                        Log.d(&quot;Firebase&quot;, &quot;Data berhasil diperbarui untuk $houseNumber&quot;)&#10;                                        Toast.makeText(context, &quot;Keterangan berhasil simpan&quot;, Toast.LENGTH_SHORT).show()&#10;                                    } else {&#10;                                        Log.e(&quot;Firebase&quot;, &quot;Gagal memperbarui data: ${task.exception?.message}&quot;)&#10;                                    }&#10;                                }&#10;                        }&#10;                    } else {&#10;                        Log.e(&quot;Firebase&quot;, &quot;Data dengan houseNumber $houseNumber tidak ditemukan&quot;)&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Log.e(&quot;Firebase&quot;, &quot;Error: ${error.message}&quot;)&#10;                }&#10;            })&#10;    }&#10;&#10;    //fun utk fetch no hp dan note user&#10;    fun fetchUserData(houseNumber: String) {&#10;        usersRef.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        val userSnapshot = snapshot.children.first()&#10;                        val phoneNumber = userSnapshot.child(&quot;phoneNumber&quot;).getValue(String::class.java) ?: &quot;&quot;&#10;                        val note = userSnapshot.child(&quot;note&quot;).getValue(String::class.java) ?: &quot;&quot;&#10;                        _userData.postValue(&#10;                            mapOf(&#10;                                &quot;phoneNumber&quot; to phoneNumber,&#10;                                &quot;note&quot; to note)&#10;                        )&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Log.e(&quot;fetchUserData&quot;, &quot;Gagal mengambil data: ${error.message}&quot;)&#10;                }&#10;            })&#10;    }&#10;&#10;    private fun getCurrentTimestampFormatted(): String {&#10;        val sdf = java.text.SimpleDateFormat(&quot;yyyy-MM-dd 'waktu' HH:mm&quot;, java.util.Locale.getDefault())&#10;        return sdf.format(java.util.Date())&#10;    }&#10;&#10;    // Helper untuk mengambil perumahanId dari SharedPreferences&#10;    fun getPerumahanId(): String {&#10;        return userPreferences.getPerumahanId() ?: &quot;&quot;&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.panicbuttonrtdb.viewmodel&#10;&#10;import android.content.Context&#10;import android.net.Uri&#10;import android.util.Log&#10;import android.widget.Toast&#10;import androidx.compose.runtime.getValue&#10;import androidx.compose.runtime.mutableStateOf&#10;import androidx.compose.runtime.setValue&#10;import androidx.lifecycle.LiveData&#10;import androidx.lifecycle.MutableLiveData&#10;import androidx.lifecycle.ViewModel&#10;import androidx.lifecycle.viewModelScope&#10;import com.example.panicbuttonrtdb.data.MonitorRecord&#10;import com.example.panicbuttonrtdb.data.User&#10;import com.example.panicbuttonrtdb.data.UserPreferences&#10;import com.google.firebase.database.DataSnapshot&#10;import com.google.firebase.database.DatabaseError&#10;import com.google.firebase.database.FirebaseDatabase&#10;import com.google.firebase.database.ValueEventListener&#10;import com.google.firebase.storage.FirebaseStorage&#10;import kotlinx.coroutines.flow.MutableStateFlow&#10;import kotlinx.coroutines.flow.StateFlow&#10;import kotlinx.coroutines.launch&#10;&#10;open class ViewModel(private val context: Context) : ViewModel() {&#10;&#10;    private val database = FirebaseDatabase.getInstance()&#10;    private val storage = FirebaseStorage.getInstance().reference&#10;    private val userPreferences = UserPreferences(context)&#10;    private val monitorRef = database.getReference(&quot;monitor&quot;)&#10;    private val usersRef = database.getReference(&quot;users&quot;)&#10;&#10;    var currentUserName by mutableStateOf(&quot;&quot;)&#10;    var currentUserHouseNumber by mutableStateOf(&quot;&quot;)&#10;&#10;    private val _monitorData = MutableLiveData&lt;List&lt;MonitorRecord&gt;&gt;()&#10;    val monitorData: LiveData&lt;List&lt;MonitorRecord&gt;&gt; get() = _monitorData&#10;&#10;    private val _userData = MutableLiveData&lt;Map&lt;String, String&gt;&gt;()&#10;    val userData: LiveData&lt;Map&lt;String, String&gt;&gt; get() = _userData&#10;&#10;    private val _latestRecord = MutableStateFlow(MonitorRecord())&#10;    val latestRecord: StateFlow&lt;MonitorRecord&gt; = _latestRecord&#10;&#10;    // FIX: LiveData untuk memantau status buzzer dari path ESP8266 yang benar&#10;    private val _buzzerState = MutableLiveData&lt;String&gt;()&#10;    val buzzerState: LiveData&lt;String&gt; = _buzzerState&#10;&#10;    init {&#10;        // Ambil data pengguna yang tersimpan saat aplikasi dibuka kembali&#10;        currentUserName = userPreferences.getUserName() ?: &quot;&quot;&#10;        currentUserHouseNumber = userPreferences.getHouseNumber() ?: &quot;&quot;&#10;&#10;        fetchLatestRecord()&#10;&#10;        // FIX: Inisialisasi listener buzzer state dari path ESP8266&#10;        getBuzzerState()&#10;    }&#10;&#10;    fun isUserLoggedIn(): Boolean {&#10;        return userPreferences.isUserLoggedIn()&#10;    }&#10;&#10;    fun isAdminLoggedIn(): Boolean {&#10;        return userPreferences.isAdminLoggedIn()&#10;    }&#10;&#10;    // FIX: Simpan user ke struktur Firebase yang benar: /users/{uid}/...&#10;    fun saveUserToFirebase(&#10;        name: String,&#10;        houseNumber: String,&#10;        password: String,&#10;        onSuccess: () -&gt; Unit,&#10;        onFailure: (String) -&gt; Unit,&#10;        perumahanId: String? = null&#10;    ) {&#10;        // FIX: Gunakan path perumahan yang benar&#10;        val targetRef = if (!perumahanId.isNullOrEmpty()) {&#10;            database.getReference(&quot;perumahan&quot;).child(perumahanId).child(&quot;users&quot;)&#10;        } else {&#10;            usersRef&#10;        }&#10;&#10;        targetRef.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        onFailure(&quot;Nomor rumah sudah digunakan.&quot;)&#10;                        Toast.makeText(context, &quot;Nomor rumah sudah digunakan&quot;, Toast.LENGTH_SHORT).show()&#10;                    } else {&#10;                        targetRef.orderByChild(&quot;name&quot;).equalTo(name)&#10;                            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                                override fun onDataChange(snapshot: DataSnapshot) {&#10;                                    if (snapshot.exists()) {&#10;                                        onFailure(&quot;Nama sudah digunakan.&quot;)&#10;                                        Toast.makeText(context, &quot;Nama sudah digunakan&quot;, Toast.LENGTH_SHORT).show()&#10;                                    } else {&#10;                                        // FIX: Simpan dengan UID sebagai key&#10;                                        val userId = targetRef.push().key&#10;                                        val user = User(name, houseNumber, password)&#10;&#10;                                        userId?.let {&#10;                                            targetRef.child(it).setValue(user)&#10;                                                .addOnCompleteListener { task -&gt;&#10;                                                    if (task.isSuccessful) {&#10;                                                        onSuccess()&#10;                                                        Toast.makeText(context, &quot;Sign Up Berhasil&quot;, Toast.LENGTH_SHORT).show()&#10;                                                    } else {&#10;                                                        onFailure(&quot;Gagal menyimpan data.&quot;)&#10;                                                    }&#10;                                                }&#10;                                        }&#10;                                    }&#10;                                }&#10;&#10;                                override fun onCancelled(error: DatabaseError) {&#10;                                    onFailure(&quot;Terjadi kesalahan: ${error.message}&quot;)&#10;                                }&#10;                            })&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    onFailure(&quot;Terjadi kesalahan: ${error.message}&quot;)&#10;                }&#10;            })&#10;    }&#10;&#10;    // FIX: Validasi login dengan path yang benar&#10;    fun validateLogin(houseNumber: String, password: String, onResult: (Boolean, Boolean) -&gt; Unit) {&#10;        val adminHouseNumber = &quot;admin&quot;&#10;        val adminPassword = &quot;admin&quot;&#10;&#10;        if (houseNumber == adminHouseNumber &amp;&amp; password == adminPassword) {&#10;            userPreferences.saveAdminLoggedIn(true)&#10;            onResult(true, true)&#10;            return&#10;        }&#10;&#10;        val perumahanId = userPreferences.getPerumahanId() ?: &quot;&quot;&#10;        if (perumahanId.isEmpty()) {&#10;            onResult(false, false)&#10;            return&#10;        }&#10;&#10;        // FIX: Path sesuai struktur: perumahan/{perumahanId}/users&#10;        val usersRef = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;users&quot;)&#10;&#10;        usersRef.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (!snapshot.exists()) {&#10;                        onResult(false, false)&#10;                        return&#10;                    }&#10;&#10;                    for (child in snapshot.children) {&#10;                        val user = child.getValue(User::class.java)&#10;&#10;                        if (user != null &amp;&amp; user.password == password) {&#10;                            // FIX: Simpan user ID untuk tracking monitor data&#10;                            val userId = child.key ?: &quot;&quot;&#10;                            &#10;                            userPreferences.saveUserLoggedIn(true)&#10;                            userPreferences.saveUserInfo(user.name, user.houseNumber)&#10;&#10;                            currentUserName = user.name&#10;                            currentUserHouseNumber = user.houseNumber&#10;&#10;                            onResult(true, false)&#10;                            return&#10;                        }&#10;                    }&#10;&#10;                    onResult(false, false)&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    onResult(false, false)&#10;                }&#10;            })&#10;    }&#10;&#10;    fun logout() {&#10;        userPreferences.saveUserLoggedIn(false)&#10;        currentUserName = &quot;&quot;&#10;        currentUserHouseNumber = &quot;&quot;&#10;    }&#10;&#10;    fun adminLogout() {&#10;        userPreferences.saveAdminLoggedIn(false)&#10;        userPreferences.clearUserInfo()&#10;    }&#10;&#10;    // FIX: Simpan monitor data dengan user yang BENAR dari session aktif&#10;    // FIX: Path: /perumahan/{perumahanKey}/monitor/{pushId}&#10;    fun saveMonitorData(&#10;        message: String,&#10;        priority: String,&#10;        status: String,&#10;        latitude: Double,&#10;        longitude: Double&#10;    ) {&#10;        // FIX: SELALU ambil dari UserPreferences untuk menghindari stale data&#10;        val latestName = userPreferences.getUserName() ?: &quot;&quot;&#10;        val latestHouseNumber = userPreferences.getHouseNumber() ?: &quot;&quot;&#10;        val perumahanId = getPerumahanId()&#10;&#10;        // FIX: Update variabel instance juga&#10;        currentUserName = latestName&#10;        currentUserHouseNumber = latestHouseNumber&#10;&#10;        if (perumahanId.isEmpty()) {&#10;            Log.e(&quot;Firebase&quot;, &quot;saveMonitorData: perumahanId kosong, tidak dapat menyimpan&quot;)&#10;            return&#10;        }&#10;&#10;        val data = mapOf(&#10;            &quot;name&quot; to latestName,&#10;            &quot;houseNumber&quot; to latestHouseNumber,&#10;            &quot;message&quot; to message,&#10;            &quot;priority&quot; to priority,&#10;            &quot;status&quot; to status,&#10;            &quot;time&quot; to getCurrentTimestampFormatted(),&#10;            &quot;latitude&quot; to latitude,&#10;            &quot;longitude&quot; to longitude&#10;        )&#10;&#10;        // FIX: Simpan ke path perumahan yang benar&#10;        val monitorRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;monitor&quot;)&#10;&#10;        monitorRefPerumahan.push().setValue(data)&#10;            .addOnCompleteListener { task -&gt;&#10;                if (task.isSuccessful) {&#10;                    Log.d(&quot;Firebase&quot;, &quot;Data berhasil disimpan ke /perumahan/$perumahanId/monitor&quot;)&#10;                } else {&#10;                    Log.e(&quot;Firebase&quot;, &quot;Gagal menyimpan data&quot;, task.exception)&#10;                }&#10;            }&#10;    }&#10;&#10;    // FIX: Baca buzzer state dari path ESP8266 yang BENAR&#10;    // ESP membaca: /perumahan/{perumahanKey}/buzzers/main/state&#10;    private fun getBuzzerState() {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) {&#10;            _buzzerState.value = &quot;off&quot;&#10;            Log.w(&quot;Firebase&quot;, &quot;getBuzzerState: perumahanId kosong, set state = off&quot;)&#10;            return&#10;        }&#10;&#10;        // FIX: Path EKSAK sesuai ESP8266&#10;        val stateRef = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;buzzers&quot;)&#10;            .child(&quot;main&quot;)&#10;            .child(&quot;state&quot;)&#10;&#10;        stateRef.addValueEventListener(object : ValueEventListener {&#10;            override fun onDataChange(snapshot: DataSnapshot) {&#10;                val state = snapshot.getValue(String::class.java) ?: &quot;off&quot;&#10;                _buzzerState.value = state&#10;                Log.d(&quot;Firebase&quot;, &quot;buzzerState updated: $state&quot;)&#10;            }&#10;&#10;            override fun onCancelled(error: DatabaseError) {&#10;                Log.e(&quot;Firebase&quot;, &quot;getBuzzerState cancelled: ${error.message}&quot;)&#10;                _buzzerState.value = &quot;off&quot;&#10;            }&#10;        })&#10;    }&#10;&#10;    // FIX: SATU-SATUNYA fungsi untuk menulis buzzer data&#10;    // ESP membaca dari: /perumahan/{perumahanKey}/buzzers/main/state dan /level&#10;    // Format level HARUS: &quot;biasa&quot;, &quot;penting&quot;, &quot;darurat&quot;, atau &quot;off&quot;&#10;    fun updateAlarmForPerumahan(perumahanId: String, state: String, level: String) {&#10;        if (perumahanId.isEmpty()) {&#10;            Log.e(&quot;Firebase&quot;, &quot;updateAlarmForPerumahan: perumahanId kosong&quot;)&#10;            return&#10;        }&#10;&#10;        // FIX: Path EKSAK sesuai ESP8266&#10;        val baseRef = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;buzzers&quot;)&#10;            .child(&quot;main&quot;)&#10;&#10;        // FIX: Tulis state dan level sesuai format ESP&#10;        val data = mapOf(&#10;            &quot;state&quot; to state,&#10;            &quot;level&quot; to level&#10;        )&#10;&#10;        baseRef.setValue(data)&#10;            .addOnSuccessListener {&#10;                Log.d(&quot;Firebase&quot;, &quot; Alarm updated to /perumahan/$perumahanId/buzzers/main: state=$state, level=$level&quot;)&#10;                // FIX: Update LiveData langsung untuk sinkronisasi UI&#10;                _buzzerState.value = state&#10;            }&#10;            .addOnFailureListener {&#10;                Log.e(&quot;Firebase&quot;, &quot; ERROR update alarm: ${it.message}&quot;)&#10;            }&#10;    }&#10;&#10;    // FIX: HAPUS fungsi setBuzzerState - tidak digunakan lagi&#10;    // Semua panggilan harus ke updateAlarmForPerumahan&#10;&#10;    // FIX: Refactor updateBuzzerState untuk HANYA memanggil updateAlarmForPerumahan&#10;    fun updateBuzzerState(isOn: Boolean, priority: String? = null, level: String? = null) {&#10;        val perumahanId = getPerumahanId()&#10;&#10;        if (perumahanId.isEmpty()) {&#10;            Log.e(&quot;Firebase&quot;, &quot;updateBuzzerState: perumahanId kosong&quot;)&#10;            return&#10;        }&#10;&#10;        if (!isOn) {&#10;            // FIX: OFF harus menulis state=&quot;off&quot; dan level=&quot;off&quot;&#10;            updateAlarmForPerumahan(&#10;                perumahanId = perumahanId,&#10;                state = &quot;off&quot;,&#10;                level = &quot;off&quot;&#10;            )&#10;            return&#10;        }&#10;&#10;        // FIX: ON - gunakan level yang diberikan, default &quot;biasa&quot;&#10;        // Level HARUS lowercase: &quot;biasa&quot;, &quot;penting&quot;, &quot;darurat&quot;&#10;        val finalLevel = (level ?: &quot;biasa&quot;).lowercase()&#10;&#10;        updateAlarmForPerumahan(&#10;            perumahanId = perumahanId,&#10;            state = &quot;on&quot;,&#10;            level = finalLevel&#10;        )&#10;    }&#10;&#10;    fun fetchMonitorData() {&#10;        // FIX: Baca dari path perumahan&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) {&#10;            _monitorData.value = emptyList()&#10;            return&#10;        }&#10;&#10;        val monitorRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;monitor&quot;)&#10;&#10;        monitorRefPerumahan.addValueEventListener(object : ValueEventListener {&#10;            override fun onDataChange(snapshot: DataSnapshot) {&#10;                val records = mutableListOf&lt;MonitorRecord&gt;()&#10;                for (recordSnapshot in snapshot.children.reversed()) {&#10;                    val record = recordSnapshot.getValue(MonitorRecord::class.java)&#10;                    record?.let { records.add(it) }&#10;                }&#10;                _monitorData.value = records&#10;            }&#10;&#10;            override fun onCancelled(error: DatabaseError) {&#10;                Log.e(&quot;Firebase&quot;, &quot;Failed to fetch monitor data&quot;, error.toException())&#10;            }&#10;        })&#10;    }&#10;&#10;    fun fetchLatestRecord() {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) return&#10;&#10;        val monitorRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;monitor&quot;)&#10;&#10;        monitorRefPerumahan.orderByKey().limitToLast(1)&#10;            .addValueEventListener(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        val data = snapshot.children.first().getValue(MonitorRecord::class.java)&#10;                        data?.let {&#10;                            viewModelScope.launch {&#10;                                _latestRecord.emit(it)&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Log.e(&quot;Firebase&quot;, &quot;Failed to fetch latest record&quot;, error.toException())&#10;                }&#10;            })&#10;    }&#10;&#10;    fun latestMonitorItem() {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) {&#10;            _monitorData.value = emptyList()&#10;            return&#10;        }&#10;&#10;        val monitorRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;monitor&quot;)&#10;&#10;        monitorRefPerumahan.orderByKey().limitToLast(3)&#10;            .addValueEventListener(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    val records = mutableListOf&lt;MonitorRecord&gt;()&#10;                    for (recordSnapshot in snapshot.children.reversed()) {&#10;                        val record = recordSnapshot.getValue(MonitorRecord::class.java)&#10;                        record?.let { records.add(it) }&#10;                    }&#10;                    _monitorData.value = records&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Log.e(&quot;Firebase&quot;, &quot;Failed to fetch monitor data&quot;, error.toException())&#10;                }&#10;            })&#10;    }&#10;&#10;    fun detailRekap(houseNumber: String) {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) {&#10;            _monitorData.value = emptyList()&#10;            return&#10;        }&#10;&#10;        val monitorRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;monitor&quot;)&#10;&#10;        monitorRefPerumahan.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    val records = snapshot.children.reversed().mapNotNull { recordSnapshot -&gt;&#10;                        recordSnapshot.getValue(MonitorRecord::class.java)?.copy(id = recordSnapshot.key ?: &quot;&quot;)&#10;                    }&#10;                    _monitorData.value = records&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Log.e(&quot;detailRekap&quot;, &quot;gagal mengambil data&quot;, error.toException())&#10;                }&#10;            })&#10;    }&#10;&#10;    fun userHistory() {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) {&#10;            _monitorData.value = emptyList()&#10;            return&#10;        }&#10;&#10;        val monitorRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;monitor&quot;)&#10;&#10;        monitorRefPerumahan.addValueEventListener(object : ValueEventListener {&#10;            override fun onDataChange(snapshot: DataSnapshot) {&#10;                val records = mutableListOf&lt;MonitorRecord&gt;()&#10;                // FIX: Gunakan nilai terbaru dari preferences&#10;                val currentHouse = userPreferences.getHouseNumber() ?: &quot;&quot;&#10;                &#10;                for (recordSnapshot in snapshot.children.reversed()) {&#10;                    val record = recordSnapshot.getValue(MonitorRecord::class.java)&#10;                    if (record?.houseNumber == currentHouse) {&#10;                        records.add(record)&#10;                    }&#10;                }&#10;                _monitorData.value = records&#10;            }&#10;&#10;            override fun onCancelled(error: DatabaseError) {&#10;                Log.e(&quot;Firebase&quot;, &quot;Gagal mengambil data&quot;, error.toException())&#10;            }&#10;        })&#10;    }&#10;&#10;    fun uploadImage(imageUri: Uri, houseNumber: String, imageType: String, context: Context) {&#10;        val imageRef = storage.child(&quot;${imageType}/$houseNumber.jpg&quot;)&#10;&#10;        imageRef.putFile(imageUri)&#10;            .addOnSuccessListener {&#10;                imageRef.downloadUrl.addOnSuccessListener { uri -&gt;&#10;                    saveImagePathToDatabase(uri.toString(), houseNumber, imageType, context)&#10;                }&#10;            }&#10;    }&#10;&#10;    private fun saveImagePathToDatabase(imageUri: String, houseNumber: String, imageType: String, context: Context) {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) return&#10;&#10;        val usersRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;users&quot;)&#10;&#10;        usersRefPerumahan.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        for (userSnapshot in snapshot.children) {&#10;                            userSnapshot.ref.child(imageType).setValue(imageUri)&#10;                                .addOnSuccessListener {&#10;                                    Toast.makeText(context, &quot;$imageType berhasil diperbaharui. Tunggu beberapa saat&quot;, Toast.LENGTH_SHORT).show()&#10;                                }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Toast.makeText(context, &quot;Error: ${error.message}&quot;, Toast.LENGTH_SHORT).show()&#10;                }&#10;            })&#10;    }&#10;&#10;    fun updateStatus(recordId: String) {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) return&#10;&#10;        val monitorRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;monitor&quot;)&#10;&#10;        monitorRefPerumahan.child(recordId).child(&quot;status&quot;).setValue(&quot;Selesai&quot;)&#10;    }&#10;&#10;    fun savePhoneNumberAndNote(houseNumber: String, phoneNumber: String, note: String) {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) return&#10;&#10;        val usersRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;users&quot;)&#10;&#10;        usersRefPerumahan.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        for (child in snapshot.children) {&#10;                            child.ref.child(&quot;phoneNumber&quot;).setValue(phoneNumber)&#10;                            child.ref.child(&quot;note&quot;).setValue(note)&#10;                                .addOnCompleteListener { task -&gt;&#10;                                    if (task.isSuccessful) {&#10;                                        Log.d(&quot;Firebase&quot;, &quot;Data berhasil diperbarui untuk $houseNumber&quot;)&#10;                                        Toast.makeText(context, &quot;Keterangan berhasil simpan&quot;, Toast.LENGTH_SHORT).show()&#10;                                    } else {&#10;                                        Log.e(&quot;Firebase&quot;, &quot;Gagal memperbarui data: ${task.exception?.message}&quot;)&#10;                                    }&#10;                                }&#10;                        }&#10;                    } else {&#10;                        Log.e(&quot;Firebase&quot;, &quot;Data dengan houseNumber $houseNumber tidak ditemukan&quot;)&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Log.e(&quot;Firebase&quot;, &quot;Error: ${error.message}&quot;)&#10;                }&#10;            })&#10;    }&#10;&#10;    fun fetchUserData(houseNumber: String) {&#10;        val perumahanId = getPerumahanId()&#10;        if (perumahanId.isEmpty()) return&#10;&#10;        val usersRefPerumahan = database.getReference(&quot;perumahan&quot;)&#10;            .child(perumahanId)&#10;            .child(&quot;users&quot;)&#10;&#10;        usersRefPerumahan.orderByChild(&quot;houseNumber&quot;).equalTo(houseNumber)&#10;            .addListenerForSingleValueEvent(object : ValueEventListener {&#10;                override fun onDataChange(snapshot: DataSnapshot) {&#10;                    if (snapshot.exists()) {&#10;                        val userSnapshot = snapshot.children.first()&#10;                        val phoneNumber = userSnapshot.child(&quot;phoneNumber&quot;).getValue(String::class.java) ?: &quot;&quot;&#10;                        val note = userSnapshot.child(&quot;note&quot;).getValue(String::class.java) ?: &quot;&quot;&#10;                        _userData.postValue(&#10;                            mapOf(&#10;                                &quot;phoneNumber&quot; to phoneNumber,&#10;                                &quot;note&quot; to note&#10;                            )&#10;                        )&#10;                    }&#10;                }&#10;&#10;                override fun onCancelled(error: DatabaseError) {&#10;                    Log.e(&quot;fetchUserData&quot;, &quot;Gagal mengambil data: ${error.message}&quot;)&#10;                }&#10;            })&#10;    }&#10;&#10;    private fun getCurrentTimestampFormatted(): String {&#10;        val sdf = java.text.SimpleDateFormat(&quot;yyyy-MM-dd 'waktu' HH:mm&quot;, java.util.Locale.getDefault())&#10;        return sdf.format(java.util.Date())&#10;    }&#10;&#10;    // FIX: Helper untuk mengambil perumahanId dari SharedPreferences&#10;    fun getPerumahanId(): String {&#10;        return userPreferences.getPerumahanId() ?: &quot;&quot;&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>